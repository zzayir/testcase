<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register New User</title>
  <link rel="stylesheet" href="style-register.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div class="registration-container">
    <div class="progress-bar">
      <div class="progress-step" id="step1-progress">1</div>
      <div class="progress-step" id="step2-progress">2</div>
      <div class="progress-step" id="step3-progress">3</div>
      <div class="progress-step" id="step4-progress">4</div>
    </div>

    <!-- Step 1: Basic Info -->
    <div class="registration-step active" id="step1">
      <div class="step-header">
        <h2>Create Your Account</h2>
        <p>Enter your basic information to get started</p>
      </div>
      
      <div class="form-group">
        <label for="username">Username</label>
        <div class="input-with-icon">
          <i class="fas fa-user"></i>
          <input type="text" id="username" placeholder="Enter your username" required>
        </div>
      </div>
      
      <div class="form-group">
        <label for="email">Email</label>
        <div class="input-with-icon">
          <i class="fas fa-envelope"></i>
          <input type="email" id="email" placeholder="Enter your email" required>
        </div>
      </div>
      
      <div class="form-group">
        <label for="password">Password</label>
        <div class="input-with-icon">
          <i class="fas fa-lock"></i>
          <input type="password" id="password" placeholder="Create a password" required>
        </div>
      </div>
      
      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <div class="input-with-icon">
          <i class="fas fa-lock"></i>
          <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn-primary" onclick="checkStep1()">Continue <i class="fas fa-arrow-right"></i></button>
      </div>
      
      <p id="message" class="error-message"></p>
    </div>

    <!-- Step 2: Mobile & OTP -->
    <div class="registration-step" id="step2">
      <div class="step-header">
        <h2>Mobile Verification</h2>
        <p>We'll send a verification code to your mobile number</p>
      </div>
      
      <div class="form-group">
        <label for="mobile">Mobile Number</label>
        <div class="mobile-input-group">
          <select id="countryCode" class="country-code-select">
            <option value="+1">+1 (US)</option>
            <option value="+44">+44 (UK)</option>
            <option value="+91">+91 (IN)</option>
          </select>
          <input type="text" id="mobile" placeholder="Enter your mobile number" required>
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn-primary" onclick="sendOTP()">Send Verification Code</button>
      </div>
      
      <div class="otp-group" id="otp-section" style="display:none">
        <label for="otp">Enter Verification Code</label>
        <input type="text" id="otp" placeholder="Enter 6-digit code">
        <button class="btn-primary" onclick="verifyOTP()" id="verifyBtn">Verify</button>
        <p class="resend-otp">Didn't receive code? <a href="#" onclick="sendOTP()">Resend</a></p>
      </div>
      
      <div class="form-actions">
        <button class="btn-secondary" onclick="skipOTP()">Skip Verification</button>
        <button class="btn-back" onclick="backToStep1()"><i class="fas fa-arrow-left"></i> Back</button>
      </div>
      
      <p id="otpMsg" class="error-message"></p>
    </div>

    <!-- Step 3: NFC Prompt -->
    <div class="registration-step" id="step3">
      <div class="step-header">
        <h2>Enhanced Security</h2>
        <p>Add an extra layer of protection to your account</p>
      </div>
      
      <div class="nfc-prompt">
        <div class="nfc-icon">
          <i class="fas fa-ring"></i>
        </div>
        <h3>Enable NFC Ring Authenticator?</h3>
        <p>Secure your account with NFC technology for passwordless authentication</p>
        
        <div class="nfc-options">
          <button class="btn-primary" onclick="handleNFCChoice(true)">Yes, Enable NFC</button>
          <button class="btn-secondary" onclick="handleNFCChoice(false)">No Thanks</button>
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn-back" onclick="backToStep2()"><i class="fas fa-arrow-left"></i> Back</button>
      </div>
    </div>

    <!-- Step 4: NFC Auth -->
    <div class="registration-step" id="step4">
      <div class="step-header">
        <h2>Register NFC Ring</h2>
        <p>Scan your NFC ring to complete setup</p>
      </div>
      
      <div class="nfc-scan">
        <div class="nfc-animation">
          <div class="nfc-ring">
            <i class="fas fa-ring"></i>
          </div>
          <div class="nfc-waves"></div>
        </div>
        <p>Hold your NFC ring near your device</p>
        <button class="btn-primary" onclick="scanNFC()">Scan Now</button>
        <p id="nfc-status" class="status-message"></p>
      </div>
      
      <div class="form-actions">
        <button class="btn-back" onclick="backToStep3()"><i class="fas fa-arrow-left"></i> Back</button>
      </div>
    </div>

    <!-- Final Step -->
    <div class="registration-step" id="step5">
      <div class="final-step-container">
        <div id="final-content">
          <!-- This will be dynamically populated by JavaScript -->
          <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processing your registration...</p>
          </div>
        </div>
        
        <div class="form-actions" id="final-actions" style="display: none;">
          <button class="btn-primary" onclick="window.location.href='employee.html'">
            <i class="fas fa-tachometer-alt"></i> Employee Dashboard
          </button>
          <button class="btn-secondary" onclick="backToStep4()">
            <i class="fas fa-arrow-left"></i> Back
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Current step tracking and form data
    let currentStep = 1;
    let formData = {
      username: '',
      email: '',
      password: '',
      mobileNumber: '',
      nfcEnabled: false,
      nfcId: null
    };
    let fullNumber = '';

    // Initialize the form
    document.addEventListener('DOMContentLoaded', function() {
      showStep(currentStep);
      populateCountryCodes();
    });

    // Helper functions
    function showError(elementId, message) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.classList.remove('hidden');
    }

    function clearError(elementId) {
      const element = document.getElementById(elementId);
      element.textContent = '';
      element.classList.add('hidden');
    }

    function showStep(step) {
      // Hide all steps
      document.querySelectorAll('.registration-step').forEach(el => {
        el.style.display = 'none';
      });
      
      // Show current step
      document.getElementById(`step${step}`).style.display = 'block';
      
      // Update progress bar
      document.querySelectorAll('.progress-step').forEach((el, index) => {
        if (index + 1 <= step) {
          el.classList.add('active');
        } else {
          el.classList.remove('active');
        }
      });
    }

    function populateCountryCodes() {
      fetch('https://restcountries.com/v3.1/all')
        .then(res => {
          if (!res.ok) throw new Error('Failed to load country codes');
          return res.json();
        })
        .then(data => {
          const select = document.getElementById('countryCode');
          select.innerHTML = ''; // Clear existing options
          data.sort((a, b) => a.name.common.localeCompare(b.name.common)).forEach(country => {
            const root = country.idd?.root || '';
            const suffix = country.idd?.suffixes ? country.idd.suffixes[0] : '';
            const option = document.createElement('option');
            option.value = root + suffix;
            option.textContent = `${country.name.common} (${option.value})`;
            select.appendChild(option);
          });
        })
        .catch(err => {
          console.error('Error loading country codes:', err);
          // Fallback to some default options
          const select = document.getElementById('countryCode');
          const option = document.createElement('option');
          option.value = '+1';
          option.textContent = 'United States (+1)';
          select.appendChild(option);
        });
    }

    // Step 1 validation
    function checkStep1() {
      clearError('message');
      
      formData.username = document.getElementById('username').value.trim();
      formData.email = document.getElementById('email').value.trim();
      formData.password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (!formData.username || !formData.email || !formData.password || !confirmPassword) {
        showError('message', 'All fields are required');
        return;
      }

      if (formData.password !== confirmPassword) {
        showError('message', 'Passwords do not match');
        return;
      }

      if (formData.password.length < 8) {
        showError('message', 'Password must be at least 8 characters');
        return;
      }

      // Check username availability
      fetch('/api/check-username', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: formData.username })
      })
      .then(res => {
        if (!res.ok) throw new Error('Username check failed');
        return res.json();
      })
      .then(data => {
        if (!data.available) {
          showError('message', 'Username not available');
        } else {
          currentStep = 2;
          showStep(currentStep);
        }
      })
      .catch(err => {
        console.error('Error checking username:', err);
        showError('message', 'Error checking username availability');
      });
    }

    // Step 2 functions
    function sendOTP() {
      clearError('otpMsg');
      
      const mobile = document.getElementById('mobile').value.trim();
      const code = document.getElementById('countryCode').value;
      
      if (!mobile) {
        showError('otpMsg', 'Mobile number is required');
        return;
      }

      fullNumber = code + mobile;
      formData.mobileNumber = fullNumber;

      fetch('/api/send-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mobileNumber: formData.mobileNumber })
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed to send OTP');
        return res.json();
      })
      .then(() => {
        document.getElementById('otp-section').style.display = 'block';
        document.getElementById('otpMsg').textContent = 'OTP sent to your mobile number';
        document.getElementById('otpMsg').classList.remove('error');
        document.getElementById('otpMsg').classList.add('success');
      })
      .catch(err => {
        console.error('Error sending OTP:', err);
        showError('otpMsg', 'Failed to send OTP');
      });
    }

    function verifyOTP() {
      const otp = document.getElementById('otp').value.trim();
      
      if (!otp) {
        showError('otpMsg', 'OTP is required');
        return;
      }

      fetch('/api/verify-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mobileNumber: formData.mobileNumber, otp })
      })
      .then(res => {
        if (!res.ok) throw new Error('OTP verification failed');
        return res.json();
      })
      .then(data => {
        if (data.verified) {
          currentStep = 3;
          showStep(currentStep);
        } else {
          showError('otpMsg', 'Incorrect OTP');
        }
      })
      .catch(err => {
        console.error('Error verifying OTP:', err);
        showError('otpMsg', 'Error verifying OTP');
      });
    }

    function skipOTP() {
      const mobile = document.getElementById('mobile').value.trim();
      const code = document.getElementById('countryCode').value;
      
      if (!mobile) {
        showError('otpMsg', 'Mobile number is required');
        return;
      }

      fullNumber = code + mobile;
      formData.mobileNumber = fullNumber;
      currentStep = 3;
      showStep(currentStep);
    }

    // Step 3 functions
    function handleNFCChoice(wantsNFC) {
      formData.nfcEnabled = wantsNFC;
      
      if (wantsNFC) {
        if ('NDEFReader' in window) {
          currentStep = 4;
          showStep(currentStep);
        } else {
          document.getElementById('nfc-status').textContent = 'NFC not supported in this browser';
          submitForm();
        }
      } else {
        submitForm();
      }
    }

// Step 4: NFC Auth - Modified scanNFC function
async function scanNFC() {
  try {
    if (!('NDEFReader' in window)) {
      throw new Error('NFC not supported');
    }

    const ndef = new NDEFReader();
    document.getElementById('nfc-status').textContent = 'Ready to scan...';

    await ndef.scan();

    ndef.onreading = async (event) => {
      try {
        // Get raw serial number bytes
        const serialBytes = new Uint8Array(event.serialNumber);
        
        // Convert to hex string without formatting
        const rawSerial = Array.from(serialBytes)
          .map(b => b.toString(16).padStart(2, '0'))
          .join('');
        
        if (!rawSerial || rawSerial.length === 0) {
          throw new Error('No serial number found on NFC device');
        }

        // Generate unique expected text for each user
        const uniqueExpectedText = "ACCESS_" + 
          Math.random().toString(36).substring(2, 8).toUpperCase() + 
          "_GRANTED";
        
        const aesKey = generateRandomHex(32);
        const encryptedText = await encryptText(uniqueExpectedText, aesKey);

        // Write to NFC tag
        const encoder = new TextEncoder();
        await ndef.write({
          records: [{
            recordType: "text",
            data: encoder.encode(encryptedText),
            lang: "en"
          }]
        });
        
        // Store NFC data in formData
        formData.nfcId = rawSerial;
        formData.authData = {
          aesKey,
          expectedText: uniqueExpectedText,
          allowedSerial: rawSerial, // Using raw serial number
          encryptedText
        };

        document.getElementById('nfc-status').textContent = 
          `NFC registered successfully!`;
        
        submitForm();
      } catch (err) {
        console.error("NFC registration error:", err);
        document.getElementById('nfc-status').textContent = 'Error: ' + err.message;
      }
    };

    ndef.onerror = (err) => {
      console.error("NFC error:", err);
      document.getElementById('nfc-status').textContent = 'NFC error: ' + err.message;
    };
  } catch (err) {
    console.error("NFC setup error:", err);
    document.getElementById('nfc-status').textContent = 'NFC error: ' + err.message;
  }
}

// Modified submitForm function to ensure authData is only included when NFC is enabled
function submitForm() {
  // Show loading state in step 5
  currentStep = 5;
  showStep(currentStep);
  
  const finalContent = document.getElementById('final-content');
  const finalActions = document.getElementById('final-actions');
  
  // Show loading state
  finalContent.innerHTML = `
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Processing your registration...</p>
    </div>
  `;
  finalActions.style.display = 'none';

  // Prepare data for submission
  const submissionData = {
    username: formData.username,
    email: formData.email,
    password: formData.password,
    mobileNumber: formData.mobileNumber
  };

  // Only include authData if NFC is enabled and we have valid data
  if (formData.nfcEnabled) {
    if (!formData.authData || !formData.authData.allowedSerial) {
      console.error('NFC enabled but missing serial number');
      finalContent.innerHTML = `
        <div class="error-message">
          <i class="fas fa-exclamation-circle"></i>
          <h3>NFC Registration Error</h3>
          <p>Failed to read NFC device serial number. Please try again.</p>
        </div>
      `;
      finalActions.style.display = 'flex';
      return;
    }
    submissionData.authData = formData.authData;
  }

  // Submit data to server
  fetch('/api/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(submissionData)
  })
  .then(res => {
    if (!res.ok) throw new Error('Registration failed');
    return res.json();
  })
  .then(data => {
    // Show success message
    finalContent.innerHTML = `
      <div class="success-message">
        <i class="fas fa-check-circle"></i>
        <h3>Registration Successful!</h3>
        <p>Your account has been successfully created${formData.nfcEnabled ? ' with NFC authentication.' : '.'}</p>
      </div>
    `;
    finalActions.style.display = 'flex';
  })
  .catch(err => {
    console.error('Error during registration:', err);
    // Show error message
    finalContent.innerHTML = `
      <div class="error-message">
        <i class="fas fa-exclamation-circle"></i>
        <h3>Registration Failed</h3>
        <p>${err.message || 'Error during registration. Please try again.'}</p>
      </div>
    `;
    finalActions.style.display = 'flex';
  });
}

    function generateRandomHex(len) {
      return Array.from(crypto.getRandomValues(new Uint8Array(len)))
        .map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function encryptText(text, hexKey) {
      try {
        const key = await crypto.subtle.importKey(
          'raw',
          new Uint8Array(hexKey.match(/.{1,2}/g).map(byte => parseInt(byte, 16))),
          'AES-CBC',
          false,
          ['encrypt']
        );
        const iv = crypto.getRandomValues(new Uint8Array(16));
        const encrypted = await crypto.subtle.encrypt(
          { name: 'AES-CBC', iv },
          key,
          new TextEncoder().encode(text)
        );
        return btoa([...iv, ...new Uint8Array(encrypted)].map(b => String.fromCharCode(b)).join(''));
      } catch (err) {
        console.error("Encryption error:", err);
        throw err;
      }
    }

    // Back navigation functions
    function backToStep1() {
      currentStep = 1;
      showStep(currentStep);
    }

    function backToStep2() {
      currentStep = 2;
      showStep(currentStep);
    }

    function backToStep3() {
      currentStep = 3;
      showStep(currentStep);
    }

    function backToStep4() {
      currentStep = 4;
      showStep(currentStep);
    }
  </script>
</body>
</html>
